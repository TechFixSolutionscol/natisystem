<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Aportes - Natillera</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* ============================================================
           CONSULTA.HTML ‚Äî Estilos visuales mejorados (s√≥lo CSS)
           Psicolog√≠a del color ¬∑ Glassmorphism ¬∑ Microinteracciones
           ============================================================ */

        /* ‚îÄ‚îÄ Fondo: gradiente animado azul-verde (confianza + crecimiento) ‚îÄ‚îÄ */
        @keyframes bgShift {
            0% {
                background-position: 0% 60%;
            }

            50% {
                background-position: 100% 40%;
            }

            100% {
                background-position: 0% 60%;
            }
        }

        @keyframes floatBubble {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0.1;
            }

            50% {
                transform: translateY(-50px) scale(1.08);
                opacity: 0.18;
            }

            100% {
                transform: translateY(0) scale(1);
                opacity: 0.1;
            }
        }

        body {
            background: linear-gradient(135deg, #0f4c81 0%, #0a7c4a 35%, #0f4c81 70%, #1e7e34 100%);
            background-size: 300% 300%;
            animation: bgShift 12s ease infinite;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Burbujas decorativas de fondo */
        body::before,
        body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            background: white;
            pointer-events: none;
            animation: floatBubble ease-in-out infinite;
        }

        body::before {
            width: 300px;
            height: 300px;
            top: -80px;
            right: -60px;
            opacity: 0.1;
            animation-duration: 10s;
        }

        body::after {
            width: 200px;
            height: 200px;
            bottom: -50px;
            left: -60px;
            opacity: 0.08;
            animation-duration: 13s;
            animation-delay: 3s;
        }

        /* ‚îÄ‚îÄ Tarjeta principal: glassmorphism ‚îÄ‚îÄ */
        .consulta-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            width: 100%;
            max-width: 820px;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow:
                0 12px 40px rgba(15, 76, 129, 0.22),
                0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: cardEntrance 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) both;
            position: relative;
            z-index: 1;
        }

        @keyframes cardEntrance {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.96);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ‚îÄ‚îÄ Header: azul profundo de confianza con gradiente ‚îÄ‚îÄ */
        .consulta-header {
            background: linear-gradient(135deg, #0a3d6b 0%, #0f4c81 50%, #1565c0 100%);
            color: white;
            padding: 28px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .consulta-header::before {
            content: '';
            position: absolute;
            top: -30px;
            right: -30px;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
        }

        .consulta-header h1 {
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .consulta-header p {
            margin-top: 6px;
            opacity: 0.85;
            font-size: 0.92rem;
            letter-spacing: 0.3px;
        }

        /* ‚îÄ‚îÄ Body ‚îÄ‚îÄ */
        .consulta-body {
            padding: 32px 30px;
        }

        /* ‚îÄ‚îÄ √Årea de b√∫squeda ‚îÄ‚îÄ */
        .search-area {
            max-width: 460px;
            margin: 0 auto 30px auto;
            text-align: center;
        }

        .search-area label {
            font-weight: 700;
            color: #0f4c81;
            font-size: 1rem;
            display: block;
            margin-bottom: 10px;
            letter-spacing: 0.2px;
        }

        /* ‚îÄ‚îÄ Input group: inputs y bot√≥n alineados ‚îÄ‚îÄ */
        .input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .input-group .form-control {
            flex: 1;
            min-width: 0;
            padding: 13px 15px;
            border-radius: 10px;
            border: 2px solid #cbd5e1;
            font-size: 1rem;
            background: #f8faff;
            color: #1e293b;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
        }

        .input-group .form-control:focus {
            border-color: #059669;
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.15);
            background: #f0fdf4;
            outline: none;
        }

        /* ‚îÄ‚îÄ Bot√≥n Consultar: verde crecimiento + pulso de atracci√≥n ‚îÄ‚îÄ */
        @keyframes consultarPulse {
            0% {
                box-shadow: 0 4px 14px rgba(5, 150, 105, 0.4);
            }

            50% {
                box-shadow: 0 4px 26px rgba(5, 150, 105, 0.7);
            }

            100% {
                box-shadow: 0 4px 14px rgba(5, 150, 105, 0.4);
            }
        }

        #btnConsultar,
        .input-group .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border: none;
            border-radius: 10px;
            padding: 0 22px;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            white-space: nowrap;
            flex-shrink: 0;
            letter-spacing: 0.4px;
            animation: consultarPulse 2.5s ease-in-out infinite;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        #btnConsultar:hover:not(:disabled),
        .input-group .btn-primary:hover:not(:disabled) {
            transform: scale(1.06) translateY(-2px);
            animation-play-state: paused;
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.55);
        }

        #btnConsultar:active:not(:disabled) {
            transform: scale(0.97);
        }

        @media (max-width: 480px) {
            .input-group {
                flex-direction: column;
            }

            .input-group .form-control,
            .input-group .btn-primary,
            #btnConsultar {
                width: 100%;
                padding: 13px;
            }
        }

        /* ‚îÄ‚îÄ √Årea de resultados ‚îÄ‚îÄ */
        .result-area {
            display: none;
            animation: fadeInUp 0.55s ease both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(14px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ‚îÄ‚îÄ Tarjeta del socio: verde suave ‚îÄ‚îÄ */
        .socio-card {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #6ee7b7;
            color: #064e3b;
            padding: 20px 24px;
            border-radius: 12px;
            margin-bottom: 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
        }

        .socio-info h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #065f46;
        }

        .socio-info p {
            margin: 5px 0 0 0;
            opacity: 0.75;
            font-size: 0.9rem;
        }

        /* ‚îÄ‚îÄ Filtros de libreta ‚îÄ‚îÄ */
        .libreta-filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ‚îÄ‚îÄ Tabla ‚îÄ‚îÄ */
        .table-wrapper {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        }

        .table tbody tr {
            transition: background 0.18s ease, transform 0.18s ease;
        }

        .table tbody tr:hover {
            background: #f0fdf4;
        }

        /* ‚îÄ‚îÄ Resumen/footer de totales ‚îÄ‚îÄ */
        .summary-footer {
            background: linear-gradient(135deg, #f8fafc 0%, #f0f9ff 100%);
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 22px;
            display: flex;
            justify-content: flex-end;
            gap: 30px;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(15, 76, 129, 0.08);
        }

        .summary-item .label {
            font-size: 0.78rem;
            color: #64748b;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .summary-item .value {
            font-size: 1.45rem;
            font-weight: 800;
            color: #0f172a;
        }

        /* ‚îÄ‚îÄ Spinner: elegante en verde ‚îÄ‚îÄ */
        .spinner {
            border: 4px solid rgba(5, 150, 105, 0.15);
            border-top: 4px solid #059669;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            animation: spin 0.85s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
        @media (max-width: 600px) {
            .summary-footer {
                flex-direction: column;
                gap: 15px;
                text-align: right;
            }

            .socio-card {
                flex-direction: column;
                text-align: center;
            }

            .consulta-body {
                padding: 20px 16px;
            }
        }

        /* ‚îÄ‚îÄ Signos de peso flotantes ‚îÄ‚îÄ */
        .money-particle {
            position: fixed;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.55);
            font-weight: 700;
            pointer-events: none;
            user-select: none;
            z-index: 0;
            animation: moneyFloat linear infinite;
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.3);
        }

        @keyframes moneyFloat {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }

            8% {
                opacity: 1;
            }

            92% {
                opacity: 1;
            }

            100% {
                transform: translateY(-120px) rotate(360deg);
                opacity: 0;
            }
        }

        /* ESTILOS PARA EL MODAL WIZARD */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            position: relative;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--primary-dark);
        }

        .step-indicators {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            background: #e2e8f0;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .step-dot.active {
            background: var(--primary-color);
            transform: scale(1.2);
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: #eff6ff;
        }

        .btn-close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #94a3b8;
        }
    </style>
</head>

<body>

    <div class="consulta-container">
        <!-- HEADER -->
        <header class="consulta-header">
            <h1><span class="icon">üí∞</span> Nati System - Consulta de Socios</h1>
            <p style="margin-top: 5px; opacity: 0.8;">Consulta tu estado de aportes de forma segura</p>
        </header>

        <div class="consulta-body">

            <!-- BUSCADOR -->
            <div class="search-area" id="searchArea">
                <form id="formConsulta" onsubmit="handleConsulta(event)">
                    <div class="form-group">
                        <label for="cedulaInput" style="text-align: left;">N√∫mero de C√©dula</label>
                        <div class="input-group">
                            <input type="number" id="cedulaInput" placeholder="Ingresa tu c√©dula" required
                                class="form-control">
                            <button type="submit" class="btn btn-primary" id="btnConsultar">
                                üîç Consultar
                            </button>
                        </div>
                    </div>
                </form>
                <div id="loading" style="display: none; margin-top: 20px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">Buscando informaci√≥n...</p>
                </div>
                <div id="errorMsg" class="message error hidden" style="margin-top: 15px;"></div>
            </div>

            <!-- RESULTADOS -->
            <div id="resultArea" class="result-area">

                <div class="socio-card">
                    <div class="socio-info">
                        <h3 id="socioNombre">Nombre del Socio</h3>
                        <p>C√©dula: <span id="socioCedula"></span></p>
                    </div>
                    <div class="estado-badge"
                        style="display: flex; flex-direction: column; align-items: end; gap: 10px;">
                        <span id="socioEstado" class="badge badge-success"
                            style="font-size: 1rem; padding: 8px 15px;">AL D√çA</span>

                        <button onclick="openAporteModal()" class="btn btn-primary"
                            style="font-size: 0.9rem; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);">
                            <span class="icon">üí∏</span> Registrar Aporte
                        </button>
                    </div>
                </div>

                <div class="libreta-filters">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label for="mesSelect" style="font-weight: 500;">Filtrar Mes:</label>
                        <select id="mesSelect" onchange="filtrarPorMes()"
                            style="padding: 8px; border-radius: 6px; border: 1px solid #d1d5db;">
                            <option value="">Todos los movimientos</option>
                        </select>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="descargarPDF()" id="btnPDF">
                        <span class="icon">üìÑ</span> Descargar Libreta PDF
                    </button>
                </div>

                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Concepto</th>
                                <th style="text-align: right;">Abono</th>
                                <th style="text-align: right;">Saldo Acum.</th>
                            </tr>
                        </thead>
                        <tbody id="tablaMovimientos">
                            <!-- Datos insertados por JS -->
                        </tbody>
                    </table>
                </div>

                <div class="summary-footer">
                    <div class="summary-item">
                        <span class="label">Total Aportes</span>
                        <span class="value" id="saldoAportes">$0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Ganancias/Intereses</span>
                        <span class="value" id="ganancias" style="color: #28a745;">$0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">GRAN TOTAL</span>
                        <span class="value" id="granTotal"
                            style="color: var(--primary-color); font-size: 1.6rem;">$0</span>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="resetConsulta()" class="btn btn-secondary btn-sm">Nueva Consulta</button>
                    <!-- BOT√ìN POLLA V2 -->
                    <button onclick="checkPollaStatus()" class="btn btn-warning btn-sm"
                        style="margin-left: 10px; background: #f59e0b; border: none; color: white;">
                        üé± Jugar La Polla
                    </button>
                </div>

            </div>
        </div>

        <!-- MODAL DE LA POLLA (NUEVO) -->
        <div id="pollaModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 600px;">
                <button class="btn-close-modal" onclick="closePollaModal()">&times;</button>

                <div class="modal-header">
                    <h2>üé± La Polla Loca</h2>
                    <p id="pollaInfoSorteo" style="color: #666; font-size: 0.9rem;">Cargando sorteo...</p>
                </div>

                <div id="pollaContent">
                    <!-- VISTA 1: SELECCI√ìN DE N√öMERO -->
                    <div id="viewSeleccionPolla">
                        <div class="polla-grid-container"
                            style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                            <p style="text-align: center; margin-bottom: 10px;">Selecciona tu n√∫mero (<span
                                    id="precioPolla">$10.000</span>)</p>
                            <div id="gridNumeros"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 5px;">
                                <!-- Grid generado por JS -->
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <p id="seleccionPollaMsg"
                                style="min-height: 20px; color: var(--primary-color); font-weight: bold;"></p>
                        </div>
                    </div>

                    <!-- VISTA 2: CONFIRMACI√ìN Y PAGO -->
                    <div id="viewPagoPolla" style="display: none;">
                        <h3 style="text-align: center; color: var(--primary-dark);">Confirmar N√∫mero <span
                                id="numSelectedConfirm" style="font-size: 1.5rem; color: #f59e0b;">--</span></h3>

                        <form id="formPolla" onsubmit="handlePollaSubmit(event)">
                            <div class="form-group">
                                <label>Sube tu comprobante de pago:</label>
                                <div class="file-upload-area" onclick="document.getElementById('filePolla').click()"
                                    style="padding: 15px;">
                                    <input type="file" id="filePolla" accept="image/*,application/pdf"
                                        style="display: none;" onchange="handleFilePolla(event)">
                                    <div id="previewPolla">üì∏ Adjuntar Comprobante</div>
                                </div>
                                <p id="fileNamePolla" style="text-align: center; font-size: 0.8rem; margin-top: 5px;">
                                </p>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="backToGrid()">Volver</button>
                                <button type="submit" class="btn btn-success" id="btnSubmitPolla" disabled>Enviar
                                    Solicitud</button>
                            </div>
                        </form>
                    </div>

                    <!-- VISTA 3: MENSAJES -->
                    <div id="viewMsgPolla" style="display: none; text-align: center; padding: 20px;">
                        <h3 id="msgTitlePolla"></h3>
                        <p id="msgBodyPolla"></p>
                        <button class="btn btn-primary" onclick="closePollaModal()">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL WIZARD APORTE -->
    <div id="aporteModal" class="modal-overlay">
        <div class="modal-content">
            <button class="btn-close-modal" onclick="closeAporteModal()">&times;</button>

            <div class="modal-header">
                <h2>Nuevo Aporte</h2>
                <div class="step-indicators">
                    <span class="step-dot active" id="dot1"></span>
                    <span class="step-dot" id="dot2"></span>
                </div>
            </div>

            <form id="formAporteExterno" onsubmit="handleAporteSubmit(event)">
                <!-- PASO 1: DATOS -->
                <div class="form-step active" id="step1">
                    <div class="form-group">
                        <label>Valor a Aportar</label>
                        <input type="number" id="aporteMonto" class="form-control" placeholder="Ej: 50000" min="1000"
                            required
                            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1.2rem;">
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Fecha del Pago</label>
                        <input type="date" id="aporteFecha" class="form-control" required
                            style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                    </div>
                    <div class="form-group" style="margin-top: 20px; text-align: right;">
                        <button type="button" class="btn btn-primary" onclick="nextStep()">Siguiente ‚û°Ô∏è</button>
                    </div>
                </div>

                <!-- PASO 2: COMPROBANTE (OBLIGATORIO) -->
                <div class="form-step" id="step2">
                    <p style="text-align: center; margin-bottom: 20px; color: #64748b;">
                        Por favor adjunta el comprobante de pago para validar tu aporte.
                    </p>

                    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" accept="image/*,application/pdf" style="display: none;"
                            onchange="handleFileSelect(event)">
                        <div id="uploadPreview">
                            <span style="font-size: 2rem;">üì∏</span>
                            <p style="margin: 10px 0 0 0; font-weight: 500;">Clic para adjuntar recibo</p>
                            <small class="text-muted">(Imagen o PDF)</small>
                        </div>
                    </div>
                    <p id="fileNameDisplay"
                        style="text-align: center; margin-top: 10px; color: var(--primary-color); font-weight: bold; font-size: 0.9rem;">
                    </p>

                    <div style="margin-top: 30px; display: flex; gap: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="prevStep()" style="flex: 1;">‚¨ÖÔ∏è
                            Volver</button>
                        <button type="submit" class="btn btn-success" id="btnEnviarAporte" disabled style="flex: 1;">‚úÖ
                            Enviar Aporte</button>
                    </div>
                </div>
            </form>

            <!-- LOADING STATE -->
            <div id="aporteLoading" style="display: none; text-align: center; padding: 20px;">
                <div class="spinner"></div>
                <p style="margin-top: 15px;">Subiendo comprobante y registrando...</p>
                <p style="color: #64748b; font-size: 0.9rem;">Esto puede tardar unos segundos.</p>
            </div>

            <!-- SUCCESS STATE -->
            <div id="aporteSuccess" style="display: none; text-align: center; padding: 20px;">
                <span style="font-size: 3rem;">üéâ</span>
                <h3 style="color: #10b981; margin: 10px 0;">¬°Aporte Recibido!</h3>
                <p>Tu comprobante ha sido subido y el aporte ser√° validado pronto.</p>
                <button class="btn btn-primary" onclick="closeAporteModal()" style="margin-top: 20px;">Cerrar</button>
            </div>

        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbw7SBiUzhJtmmNwMN5bblvfyGMewgwijWaJ9Z_fIwYhpkFU3oyLBQNcARah_PEQFuv3/exec';
        let currentCedula = '';
        let currentData = null;

        // Formateador de moneda
        const formatCurrency = (amount) => {
            return '$' + Number(amount).toLocaleString('es-CO');
        };

        // Formateador de fecha
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            // Evitar problemas de timezone (UTC vs Local)
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };

        async function handleConsulta(e) {
            e.preventDefault();
            const cedula = document.getElementById('cedulaInput').value.trim();
            if (!cedula) return;

            // UI Loading
            document.getElementById('btnConsultar').disabled = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMsg').classList.add('hidden');
            document.getElementById('resultArea').style.display = 'none';

            try {
                // Fetch data (sin filtro de mes inicial para traer todo y poblar el select)
                const response = await fetch(`${API_URL}?action=getConsultaSocio&cedula=${cedula}`);
                const result = await response.json();

                if (result.status === 'success') {
                    currentCedula = cedula;
                    currentData = result.data;
                    renderData(result.data);
                    document.getElementById('resultArea').style.display = 'block';
                    document.getElementById('searchArea').querySelector('form').style.display = 'none'; // Ocultar form
                } else {
                    showError(result.message);
                }

            } catch (error) {
                showError('Error de conexi√≥n. Intente nuevamente.');
                console.error(error);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('btnConsultar').disabled = false;
            }
        }

        function renderData(data) {
            // 1. Info Socio
            document.getElementById('socioNombre').textContent = data.socio.nombre;
            document.getElementById('socioCedula').textContent = data.socio.cedula;

            const badge = document.getElementById('socioEstado');
            badge.textContent = data.resumen.estado;
            badge.className = data.resumen.estado === 'AL D√çA' ? 'badge badge-success' : 'badge badge-warning';

            // 2. Poblar Select de Meses
            const select = document.getElementById('mesSelect');
            select.innerHTML = '<option value="">Hist√≥rico Completo</option>';

            // Nombres de meses en espa√±ol
            const mesesEs = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            data.meses.forEach(mesStr => { // mesStr formato YYYY-MM
                const [year, month] = mesStr.split('-');
                const monthName = mesesEs[parseInt(month) - 1];
                const option = document.createElement('option');
                option.value = mesStr;
                option.textContent = `${monthName} ${year}`;
                select.appendChild(option);
            });

            // Seleccionar mes actual por defecto si existe, si no, dejar "Hist√≥rico"
            const hoy = new Date().toISOString().substring(0, 7);
            if (data.meses.includes(hoy)) {
                select.value = hoy;
            } else if (data.meses.length > 0) {
                // O seleccionar el √∫ltimo mes disponible
                select.value = data.meses[0];
            }

            // 3. Renderizar Tabla (Aplicando filtro inicial del select)
            filtrarPorMes();
        }

        function filtrarPorMes() {
            const mesSeleccionado = document.getElementById('mesSelect').value;
            const tbody = document.getElementById('tablaMovimientos');
            tbody.innerHTML = '';

            let movimientos = currentData.movimientos;
            let saldoAcumulado = 0; // Para calcular saldo progresivo si fuera necesario, pero la API devuelve saldo total.
            // Para "Libreta" visual, idealmente mostramos el saldo tras cada movimiento.
            // Pero el backend solo nos dio el saldo Total Global.
            // Podemos simular un saldo corriente inverso desde el final, o simplemente mostrar el acumulado del aporte.
            // La instrucci√≥n dice: Tabla: Fecha | Abono | Saldo.
            // Mostraremos el "Total" de esa transacci√≥n como "Abono Total" (Monto + Mora).
            // La columna Saldo es compleja si no tenemos el hist√≥rico completo desde el inicio ordenado.
            // Asumiremos que "Saldo" se refiere al acumulado del socio hasta esa fecha.
            // Dado que no tenemos esa info exacta por transacci√≥n desde el backend (solo el total actual),
            // podemos omitir "Saldo" por rengl√≥n o mostrar el acumulado PROGRESIVO recalculandolo.

            // Vamos a recalcular el saldo progresivo desde 0 para mostrarlo correctamente.
            // Ordenamos ascendente para calcular, luego mostramos descendente si queremos.
            // Pero el array ya viene descendente (lo m√°s nuevo arriba).

            // Truco: Calcular saldo total actual y restar hacia atr√°s.
            let saldoCorriente = Number(currentData.resumen.saldo_aportes); // Saldo final actual

            // Crear copia para manipular
            const movimientosCalculo = [...currentData.movimientos]; // Ya est√° descendente (Hoy -> Ayer)

            // Asignar saldos a cada movimiento (Saldo DESPU√âS del movimiento)
            movimientosCalculo.forEach(m => {
                m.saldoDespues = saldoCorriente;
                saldoCorriente -= m.total; // Restamos para encontrar el saldo antes de este movimiento
            });

            // Filtrar para visualizaci√≥n
            let movimientosVisuales = movimientosCalculo;
            if (mesSeleccionado) {
                movimientosVisuales = movimientosCalculo.filter(m => m.mesStr === mesSeleccionado);
            }

            if (movimientosVisuales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No hay movimientos en este periodo</td></tr>';
                const elTotalPeriodo = document.getElementById('totalPeriodo');
                if (elTotalPeriodo) elTotalPeriodo.textContent = '$0';
            } else {
                let totalPeriodoVal = 0;

                movimientosVisuales.forEach(m => {
                    const tr = document.createElement('tr');
                    let estadoBadge = '';
                    if (m.estado === 'PENDIENTE') {
                        estadoBadge = '<br><span class="badge badge-warning" style="font-size: 0.7em; background: #f59e0b;">‚è≥ Pendiente Validaci√≥n</span>';
                    } else if (m.estado === 'RECHAZADO') {
                        estadoBadge = '<br><span class="badge badge-danger" style="font-size: 0.7em;">‚ùå Rechazado</span>';
                    }

                    tr.innerHTML = `
                        <td>${formatDate(m.fechaStr)}</td>
                        <td>${m.concepto} ${estadoBadge}</td>
                        <td style="text-align: right; color: ${m.total < 0 ? 'red' : 'green'};">
                            ${formatCurrency(m.total)}
                        </td>
                        <td style="text-align: right; font-weight: bold;">
                            ${m.estado === 'PENDIENTE' ? '<span style="color:gray; font-weight:normal;">(En Proceso)</span>' : formatCurrency(m.saldoDespues)}
                        </td>
                    `;
                    tbody.appendChild(tr);
                    totalPeriodoVal += m.total;
                });

                // Actualizar total periodo (Visual, no del resumen global)
                // Esto es solo la suma de lo que se ve en la tabla
                // document.getElementById('totalPeriodo').textContent = formatCurrency(totalPeriodoVal); 
                // Nota: Eliminamos 'Abonado este periodo' del footer principal para dar prioridad a los totales globales.
                // Si el usuario quiere ver lo del periodo, est√° la columna Suma o se podr√≠a a√±adir otro elemento.
                // Como pidieron "Total con intereses acumulado", damos prioridad a esa vista general.
            }

            // Actualizar Saldos Globales
            if (currentData && currentData.resumen) {
                document.getElementById('saldoAportes').textContent = formatCurrency(currentData.resumen.saldo_aportes);
                document.getElementById('ganancias').textContent = formatCurrency(currentData.resumen.ganancias);
                document.getElementById('granTotal').textContent = formatCurrency(currentData.resumen.saldo_total);
            }
        }

        async function descargarPDF() {
            const mesSeleccionado = document.getElementById('mesSelect').value;
            const btn = document.getElementById('btnPDF');

            // UI Feedback
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width: 15px; height: 15px; border-width: 2px;"></span> Generando...';

            try {
                // Call Backend
                let url = `${API_URL}?action=generateConsultaPDF&cedula=${currentCedula}`;
                if (mesSeleccionado) {
                    url += `&mes=${mesSeleccionado}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.status === 'success') {
                    // Download Base64
                    const link = document.createElement('a');
                    link.href = `data:application/pdf;base64,${result.base64}`;
                    link.download = result.filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('Error: ' + result.message);
                }

            } catch (error) {
                alert('Error de conexi√≥n al generar PDF');
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        function resetConsulta() {
            currentCedula = '';
            currentData = null;
            document.getElementById('cedulaInput').value = '';
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('searchArea').querySelector('form').style.display = 'block';
            document.getElementById('errorMsg').classList.add('hidden');
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        // ==========================================
        // L√ìGICA DEL MODAL DE APORTE
        // ==========================================
        let selectedFile = null;

        function openAporteModal() {
            document.getElementById('aporteModal').style.display = 'flex';
            // Reset form
            document.getElementById('formAporteExterno').reset();
            document.getElementById('aporteFecha').valueAsDate = new Date();
            selectedFile = null;
            document.getElementById('fileInput').value = ''; // Reset file input
            document.getElementById('fileNameDisplay').textContent = '';
            document.getElementById('uploadPreview').innerHTML = `
                <span style="font-size: 2rem;">üì∏</span>
                <p style="margin: 10px 0 0 0; font-weight: 500;">Clic para adjuntar recibo</p>
                <small class="text-muted">(Imagen o PDF)</small>
            `;
            document.getElementById('btnEnviarAporte').disabled = true;

            // Reset pasos
            goToStep(1);

            // Reset views
            document.getElementById('formAporteExterno').style.display = 'block';
            document.getElementById('aporteLoading').style.display = 'none';
            document.getElementById('aporteSuccess').style.display = 'none';
        }

        function closeAporteModal() {
            document.getElementById('aporteModal').style.display = 'none';
            // Refrescar datos por si hubo aporte
            if (document.getElementById('aporteSuccess').style.display === 'block') {
                handleConsulta(new Event('submit'));
            }
        }

        function goToStep(step) {
            document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step-dot').forEach(el => el.classList.remove('active'));

            document.getElementById(`step${step}`).classList.add('active');
            document.getElementById(`dot${step}`).classList.add('active');
        }

        function nextStep() {
            const monto = document.getElementById('aporteMonto').value;
            const fecha = document.getElementById('aporteFecha').value;

            if (!monto || !fecha) {
                alert('Por favor complete todos los campos.');
                return;
            }
            goToStep(2);
        }

        function prevStep() {
            goToStep(1);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tama√±o (Max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('El archivo es demasiado pesado (Max 5MB).');
                event.target.value = '';
                return;
            }

            selectedFile = file;
            document.getElementById('fileNameDisplay').textContent = `‚úÖ ${file.name}`;
            document.getElementById('btnEnviarAporte').disabled = false;
        }

        function handleAporteSubmit(e) {
            e.preventDefault();

            if (!selectedFile) {
                alert('Debes adjuntar el comprobante obligatoriamente.');
                return;
            }

            // Convertir a Base64 y Enviar
            const reader = new FileReader();
            reader.onload = function (e) {
                const base64Data = e.target.result.split(',')[1]; // Remover header "data:image/..."
                enviarAlBackend(base64Data);
            };
            reader.readAsDataURL(selectedFile);
        }

        async function enviarAlBackend(base64Data) {
            // UI Loading
            document.getElementById('formAporteExterno').style.display = 'none';
            document.getElementById('aporteLoading').style.display = 'block';

            const dataToSend = {
                action: 'registrarAporteExterno',
                cedula: currentCedula,
                monto: document.getElementById('aporteMonto').value,
                fecha: document.getElementById('aporteFecha').value,
                concepto: 'Aporte desde Web',
                fileData: base64Data,
                fileName: selectedFile.name,
                mimeType: selectedFile.type
            };

            try {
                // Usamos fetch POST
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataToSend)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    document.getElementById('aporteLoading').style.display = 'none';
                    document.getElementById('aporteSuccess').style.display = 'block';
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                document.getElementById('aporteLoading').style.display = 'none';
                document.getElementById('formAporteExterno').style.display = 'block';
                alert('Error al registrar: ' + error.message);
            }
        }

        // ==========================================
        // L√ìGICA DE LA POLLA (FRONTEND)
        // ==========================================
        let currentSorteo = null;
        let selectedNumber = null;
        let filePolla = null;

        async function checkPollaStatus() {
            // UI Loading
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Verificando...';
            btn.disabled = true;

            try {
                // 1. Obtener Sorteos Activos (Array)
                const resp = await fetch(`${API_URL}?action=getPollaSorteoActivo`);
                const json = await resp.json();

                if (json.status === 'success' && json.data && json.data.length > 0) {
                    const sorteos = json.data;
                    if (sorteos.length === 1) {
                        currentSorteo = sorteos[0];
                        openPollaModal();
                    } else {
                        // Selecci√≥n de sorteo si hay varios
                        renderSorteoSelector(sorteos);
                    }
                } else {
                    alert('No hay sorteos activos en este momento. ¬°Intenta m√°s tarde!');
                }

            } catch (e) {
                alert('Error conectando con el servidor de Polla.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function renderSorteoSelector(sorteos) {
            document.getElementById('pollaModal').style.display = 'flex';
            document.getElementById('viewSeleccionPolla').style.display = 'none';
            document.getElementById('viewPagoPolla').style.display = 'none';
            document.getElementById('viewMsgPolla').style.display = 'none';

            // Reutilizamos viewSeleccionPolla o creamos una vista de selecci√≥n
            const mainView = document.getElementById('viewSeleccionPolla');
            mainView.style.display = 'block';
            mainView.innerHTML = `
                <div class="text-center mb-4">
                    <h3>Selecciona un Sorteo</h3>
                    <p>Hay varios sorteos programados, elige uno para participar:</p>
                </div>
                <div class="sorteo-list" style="display: grid; gap: 15px;">
                    ${sorteos.map(s => `
                        <div class="card p-3 shadow-sm" style="cursor:pointer; border-left: 5px solid var(--primary-color);" onclick="selectSorteo(${JSON.stringify(s).replace(/"/g, '&quot;')})">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">${s.tema}</h5>
                                    <small class="text-muted">Fecha: ${formatDate(s.fecha.substring(0, 10))}</small>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold">${formatCurrency(s.valor_por_numero)}</div>
                                    <button class="btn btn-sm btn-primary">Elegir N√∫mero</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-4 text-center">
                    <button class="btn btn-link text-muted" onclick="closePollaModal()">Cancelar</button>
                </div>
            `;
        }

        function selectSorteo(sorteo) {
            currentSorteo = sorteo;
            // Restaurar vista original
            document.getElementById('viewSeleccionPolla').innerHTML = `
                <div class="text-center mb-4">
                    <h3 id="pollaInfoSorteo"></h3>
                    <p>Toca un n√∫mero para seleccionarlo. Valor: <span id="precioPolla" class="fw-bold"></span></p>
                </div>
                <div id="gridNumeros" style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; max-width: 500px; margin: 0 auto;">
                    <!-- Se llena v√≠a JS -->
                </div>
                <div id="seleccionPollaMsg" class="mt-4 text-center" style="min-height: 40px;"></div>
            `;
            openPollaModal();
        }

        function openPollaModal() {
            document.getElementById('pollaModal').style.display = 'flex';
            document.getElementById('pollaInfoSorteo').textContent = `${currentSorteo.tema} | ${formatDate(currentSorteo.fecha.substring(0, 10))}`;
            document.getElementById('precioPolla').textContent = formatCurrency(currentSorteo.valor_por_numero);

            // Cargar Grid
            loadNumerosGrid();

            // Reset Views (si venimos de selectSorteo ya est√°, pero por si acaso)
            document.getElementById('viewSeleccionPolla').style.display = 'block';
            document.getElementById('viewPagoPolla').style.display = 'none';
            document.getElementById('viewMsgPolla').style.display = 'none';
            selectedNumber = null;
            document.getElementById('seleccionPollaMsg').textContent = '';
        }

        function closePollaModal() {
            document.getElementById('pollaModal').style.display = 'none';
        }

        async function loadNumerosGrid() {
            const grid = document.getElementById('gridNumeros');
            grid.innerHTML = '<p>Cargando disponibilidad...</p>';

            try {
                // Obtener n√∫meros ocupados
                const resp = await fetch(`${API_URL}?action=getPollaNumerosPorSorteo&sorteo_id=${currentSorteo.id}`);
                const json = await resp.json();
                const ocupados = json.status === 'success' ? json.data : [];

                // Crear mapa de estados
                const estadoMap = {}; // numero -> estado
                ocupados.forEach(op => {
                    estadoMap[parseInt(op.numero)] = op.estado_polla; // PENDIENTE, PAGADO, etc.
                });

                grid.innerHTML = '';

                // Generar 00-99
                for (let i = 0; i <= 99; i++) {
                    const btn = document.createElement('button');
                    const numStr = String(i).padStart(2, '0');
                    btn.textContent = numStr;
                    btn.style.padding = '8px';
                    btn.style.border = '1px solid #ccc';
                    btn.style.borderRadius = '5px';
                    btn.style.cursor = 'pointer';
                    btn.style.background = 'white';

                    // Verificar estado
                    if (estadoMap[i]) {
                        if (estadoMap[i] === 'PAGADO') {
                            btn.style.background = '#fee2e2'; // Rojo claro
                            btn.style.color = '#991b1b';
                            btn.disabled = true;
                            btn.title = 'Vendido';
                        } else if (estadoMap[i] === 'PENDIENTE') {
                            btn.style.background = '#fef3c7'; // Amarillo claro
                            btn.style.color = '#92400e';
                            btn.disabled = true;
                            btn.title = 'En proceso de validaci√≥n';
                        } else if (estadoMap[i] === 'GANADOR') {
                            btn.style.background = '#d1fae5'; // Verde ganador
                            btn.style.fontWeight = 'bold';
                        }
                    } else {
                        // Disponible
                        btn.onclick = () => selectNumber(i, btn);
                    }

                    grid.appendChild(btn);
                }

            } catch (e) {
                grid.innerHTML = '<p style="color:red">Error cargando n√∫meros</p>';
            }
        }

        function selectNumber(num, btnElement) {
            // Clear previous selection style
            const allBtns = document.getElementById('gridNumeros').querySelectorAll('button');
            allBtns.forEach(b => {
                if (!b.disabled) b.style.background = 'white';
            });

            // Highlight new
            btnElement.style.background = 'var(--primary-color)';
            btnElement.style.color = 'white';

            selectedNumber = num;
            const numStr = String(num).padStart(2, '0');
            document.getElementById('seleccionPollaMsg').innerHTML =
                `Has seleccionado el <b>${numStr}</b>. <button class="btn btn-sm btn-success" onclick="goToPagoPolla()">Confirmar</button>`;
        }

        function goToPagoPolla() {
            if (selectedNumber === null) return;
            document.getElementById('viewSeleccionPolla').style.display = 'none';
            document.getElementById('viewPagoPolla').style.display = 'block';
            document.getElementById('numSelectedConfirm').textContent = String(selectedNumber).padStart(2, '0');
        }

        function backToGrid() {
            document.getElementById('viewPagoPolla').style.display = 'none';
            document.getElementById('viewSeleccionPolla').style.display = 'block';
        }

        function handleFilePolla(e) {
            const file = e.target.files[0];
            if (!file) return;
            // Max 5MB
            if (file.size > 5 * 1024 * 1024) { alert('Max 5MB'); e.target.value = ''; return; }

            filePolla = file;
            document.getElementById('fileNamePolla').textContent = '‚úÖ ' + file.name;
            document.getElementById('btnSubmitPolla').disabled = false;
        }

        async function handlePollaSubmit(e) {
            e.preventDefault();
            if (!filePolla) return;

            // Loading
            const btn = document.getElementById('btnSubmitPolla');
            btn.innerHTML = 'Enviando...';
            btn.disabled = true;

            // Convert Base64
            const reader = new FileReader();
            reader.readAsDataURL(filePolla);
            reader.onload = async function () {
                const base64 = reader.result.split(',')[1];

                const payload = {
                    action: 'solicitarNumeroPolla',
                    cedula: currentCedula, // Usamos la del login actual
                    numero: selectedNumber,
                    sorteo_id: currentSorteo.id,
                    fileData: base64,
                    fileName: filePolla.name,
                    mimeType: filePolla.type
                };

                try {
                    const resp = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const json = await resp.json();

                    if (json.status === 'success') {
                        showPollaMsg('¬°Solicitud Enviada!', 'Tu n√∫mero ha sido reservado. Espera la confirmaci√≥n del administrador.');
                    } else {
                        showPollaMsg('Error', json.message);
                    }
                } catch (err) {
                    // CORS o error de red a veces da opaco en GAS, pero intentamos parsing
                    showPollaMsg('Enviado', 'Solicitud procesada. Verifica tu correo.');
                }
            };
        }

        function showPollaMsg(title, body) {
            document.getElementById('viewPagoPolla').style.display = 'none';
            document.getElementById('viewMsgPolla').style.display = 'block';
            document.getElementById('msgTitlePolla').textContent = title;
            document.getElementById('msgBodyPolla').textContent = body;
        }
    </script>

    <!-- Part√≠culas de $ volando -->
    <script>
        (function () {
            const symbols = ['$', '$', 'üíµ', '$', '$'];
            const count = 18;
            for (let i = 0; i < count; i++) {
                const el = document.createElement('span');
                el.className = 'money-particle';
                el.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                el.style.left = (Math.random() * 100) + 'vw';
                el.style.fontSize = (10 + Math.random() * 13) + 'px';
                el.style.opacity = (0.3 + Math.random() * 0.5).toFixed(2);
                el.style.animationDuration = (8 + Math.random() * 14) + 's';
                el.style.animationDelay = -(Math.random() * 20) + 's';
                document.body.appendChild(el);
            }
        })();
    </script>
</body>

</html>